from flask import Flask, request, redirect, render_template, url_for, session
from flask_sqlalchemy import SQLAlchemy
from sqlalchemy import Integer
from sqlalchemy.orm import Mapped
from flask_bcrypt import Bcrypt
from flask_login import (
    UserMixin,
    LoginManager,
    current_user,
    login_user,
    logout_user,
    login_required,
)

# LOGGING FORMAT
LOG = '\033[100;92mLOG ::'
FAIL = '\033[100;91mFAIL::'

# Flask Setup {{{
app = Flask(__name__)
from os import urandom

app.config['SECRET_KEY'] = urandom(24)

# Bcrypt Setup
bcrypt = Bcrypt(app)

print(app.secret_key)
# Login manager setup
login_manager = LoginManager()
login_manager.init_app(app)

# Flask-SQLAlchemy
db = SQLAlchemy()
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///app.db'
db.init_app(app)


class User(UserMixin, db.Model):
    __tablename__ = 'user'
    user_id: Mapped[int] = db.Column(db.Integer, primary_key=True)
    username: Mapped[str] = db.Column(db.Text(50), unique=True, nullable=False)
    hash: Mapped[str] = db.Column(db.Text(60), nullable=False)

    def __repr__(self):
        return f'<User {self.username}>'


class Post(db.Model):
    __tablename__ = 'post'
    post_id: Mapped[int] = db.Column(db.Integer, primary_key=True)
    title: Mapped[str] = db.Column(db.Text(50), nullable=False)
    description: Mapped[str] = db.Column(db.Text, nullable=True)
    code: Mapped[str] = db.Column(db.Text, nullable=False)
    rating: Mapped[str] = db.Column(db.Float, nullable=False, default=0)

    def __repr__(self):
        return f'<Post {self.title}>'


class Tags(db.Model):
    tag_id: Mapped[int] = db.Column(db.Integer, primary_key=True)
    post_id: Mapped[int] = db.Column(db.Integer, db.ForeignKey('post.post_id'))
    post = db.relationship('Post', backref=db.backref('post', uselist=False))
    tag_content: Mapped[str] = db.Column(db.Text, nullable=False)

    def __repr__(self):
        return f'<Tag {self.tag_content}>'


class Request(UserMixin, db.Model):
    author_id: Mapped[int] = db.Column(Integer, db.ForeignKey('user.user_id'))
    username: Mapped[str] = db.Column(
        db.String(50), unique=True, nullable=False
    )
    hash = db.Column(db.String(60), nullable=False)

    def __repr__(self):
        return f'<User {self.username}>'


with app.app_context():
    db.create_all()


@login_manager.user_loader
def load_user(user_id):
    return User.query.get(user_id)


# }}}


@app.route('/')  # {{{
def index():
    print(LOG, User.is_active, User.is_authenticated)
    print(
        FAIL,
        User.query.all(),
        current_user.is_active,
        current_user.is_authenticated,
    )
    return render_template(
        'index.html', is_active=current_user.is_active
    )  # }}}


@app.route('/register', methods=['GET', 'POST'])  # {{{
def register():
    if request.method == 'POST':
        username = request.form.get('username')
        password = request.form.get('password')
        confirm_password = request.form.get('confirm_password')
        if not username or not password or not confirm_password:
            return render_template(
                'register.html', warning='Do not leave the input blank'
            )
        elif password != confirm_password:
            return render_template(
                'register.html', warning='Passwords are not the same'
            )
        elif len(username) < 4 or len(password) < 4:
            return render_template(
                'register.html',
                warning='Username or password must be atleast 4 characters long',
            )
        elif len(username) > 50 or len(password) > 50:
            return render_template(
                'register.html',
                warning='Username or password must not be longer than 50 characters',
            )
        elif not username.isalnum():
            return render_template(
                'register.html',
                warning='Usernames must only contain English characters or numbers',
            )
        elif ' ' in password and password.isascii():
            return render_template(
                'register.html',
                warning='Usernames must only contain English characters or numbers',
            )

        username = username.lower()
        if User.query.filter_by(username=username).first():
            return render_template(
                'register.html',
                warning='That username already exists',
            )

        hash = bcrypt.generate_password_hash(password)

        db.session.add(User(username=username, hash=hash))
        db.session.commit()

        return redirect(url_for('login'))
    else:
        return render_template('register.html')  # }}}


@app.route('/login', methods=['GET', 'POST'])  # {{{
@login_manager.unauthorized_handler
def login():
    if request.method == 'POST':
        username = request.form.get('username')
        password = request.form.get('password')
        if not username or not password:
            return render_template(
                'login.html', warning='Do not leave the input blank'
            )
        username = username.lower()
        query = User.query.filter_by(username=username).first()
        print(LOG, query)
        if not query:
            return render_template(
                'login.html',
                warning="That user doesn't exist",
            )
        hash = query.hash
        if not bcrypt.check_password_hash(hash, password):
            return render_template('login.html', warning='Wrong password')

        login_user(query)
        return redirect(url_for('index'))
    else:
        return render_template('login.html')


# }}}


@app.route('/logout')  # {{{
def logout():
    logout_user()
    return redirect(url_for('index'))  # }}}


@app.route('/discover')  # {{{
def discover():
    logout_user()
    return redirect(url_for('index'))  # }}}


if __name__ == '__main__':
    app.run()
